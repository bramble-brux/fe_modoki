# 作業管理タイマー 要件定義書 - v3.0

## 1. 概要

[「１５分チェンジ法」](https://ixy.blog.jp/archives/2366349.html)に基づき、集中力を最大化する iOS タイマーアプリ。
仕事（Work）と休憩（Free）を交互に繰り返し、作業のハードルを下げつつ深い集中（フロー）を目指す。

### 1.1 基本思想

- **Work の延長は「良いこと」**: 作業にノっている状態（フロー）であり、無理に止める必要はない。超過時間はセージグリーンで表示し、成果として可視化する。
- **Free の延長は「厳禁」**: 休憩の延長は集中サイクルを崩壊させる。目標到達で即座にアラートを鳴らし、アプリ起動中は10秒ごとにアラート＋通知を繰り返す。バックグラウンド時も10秒間隔で通知を送信する。タイマーは 0:00 で停止し、コーラル色で警告表示にする。
- **15分はあくまで目安**: 設定画面で自由にカスタマイズ可能だが、元メソッドでは15分が推奨されている。

## 2. 画面構成

アプリは以下の4画面＋2シートで構成される。

| 画面 | 概要 |
|------|------|
| 開始画面 | Work/Free の開始、カレンダー・設定へのアクセス |
| タイマー画面 | カウントダウン/カウントアップ、モード切替、一時停止、終了 |
| 完了画面 | セッション結果（Work 合計時間）の表示 |
| カレンダー画面 | 月間統計チャート＋ Work 履歴リスト |
| 設定シート | Work/Free の目標時間、通知のON/OFF |

## 3. 画面別仕様

### 3.1 開始画面

- ダークテーマベースのミニマルデザイン
- 画面中央に「15 / min change」のブランディング
- **Work スタート** ボタン（炎アイコン、銅色アクセント）
- **Free スタート** ボタン（カップアイコン、ティール色アクセント）
- 画面下部にカレンダー・設定のアイコンツールバー

### 3.2 タイマー画面

#### 共通
- 画面上部: アクセント色のカプセルピルでモードアイコン＋モード名を表示
- 画面中央: タイマー表示（MM:SS or H:MM:SS）
- 画面下部: モード切替ボタン（大）＋ ユーティリティボタン（小）

#### 仕事モード（Work）
| 状態 | 背景 | タイマー色 | 計測方式 | 操作 |
|------|------|-----------|----------|------|
| カウントダウン中 | 暖色系グラデーション | 白 | 目標時間から減算 | Freeへ(大), 一時停止(小), 終了(小) |
| 超過（カウントアップ） | 暖色系グラデーション | セージグリーン | 0:00 からの加算 | Freeへ(大), 一時停止(小), 終了(小) |
| 一時停止中 | 暖色系グラデーション | 白/緑 | 停止 | Freeへ(大), 再開(小), 終了(小) |

- 超過時に「(超過)」等のラベルは表示しない。色の変化で判別する。
- **超過はフロー状態の証。** ユーザーが自発的に切り替えるまで制限しない。
- **ボタンレイアウトは一時停止/再開の切替時に変動しないこと。**
- **目標達成時**: 通知 ON の場合、アラート音を1回鳴らし＋通知を送信する。

#### 自由モード（Free）
| 状態 | 背景 | タイマー色 | 計測方式 | 操作 |
|------|------|-----------|----------|------|
| カウントダウン中 | 寒色系グラデーション | 白 | 目標時間から減算 | Workへ(大), 一時停止(小), 終了(小) |
| 超過（0:00 停止） | 寒色系グラデーション | コーラル | 0:00 で停止 | Workへ(大), 一時停止(非活性), 終了(小) |

- Free 超過時、一時停止ボタンは **非活性（グレーアウト）** とし、レイアウトは維持する。
- **Free の延長は厳禁。** アプリ起動中は10秒ごとにアラート音＋通知バナーで催促する。バックグラウンド時も10秒間隔で通知を送信する。

### 3.3 完了画面

- 「お疲れ様でした」メッセージ
- 今回のセッションの **Work 合計時間** を表示
- 「スタートに戻る」ボタン

### 3.4 カレンダー画面

- タイトル: 「カレンダー」
- **月間統計セクション**: 今月の Work 合計時間＋棒グラフで各日付の作業時間を可視化
- **Work 履歴セクション**: Work 記録のみ表示（Free は非表示）
  - 各レコード: 日付、時刻、所要時間
- 閉じるボタン: ✕ アイコン（開始画面に戻る）
- 最大保存件数: 100件

### 3.5 設定シート

- 全て日本語表記
- Work 目標時間（分・秒）
- Free 目標時間（分・秒）
- Work 目標達成時に通知（ON/OFF トグル）
- 「完了」ボタンで閉じる

## 4. データモデル

### SessionRecord
| フィールド | 型 | 説明 |
|-----------|------|------|
| id | UUID | 一意識別子 |
| date | Date | 記録日時 |
| mode | TimerMode | 常に `.work` で保存 |
| durationSeconds | Int | セッション中の Work 合計秒数 |
| notes | String | ユーザーメモ（初期値: 空文字） |

### 記録タイミング
- **「終了」ボタン押下時** にセッション中の Work 時間の合計を1レコードとして保存する。
- モード切替時（Free へ / Work へ）には保存しない（sessionWorkSeconds に累積のみ）。

## 5. 通知・アラート仕様

| イベント | アラート音 | 通知タイトル | 通知本文 |
|---------|----------|------------|---------|
| Work 目標達成 | 1回鳴動 | work終了です、お疲れ様でした | （空） |
| Free 超過開始 | 鳴動開始 | workの時間です | free時間を超過しています。 |
| Free 超過中 | 3秒ごとに繰り返し | workの時間です（1分ごと） | free時間を{N}分超過しています。 |
| バックグラウンド予約（Work） | — | work終了です、お疲れ様でした | （空） |
| バックグラウンド予約（Free） | — | workの時間です | free時間を超過しています。 |

- Work 目標達成: アラート音1回＋通知1回（設定 ON 時のみ）。
- Free 超過: アラート音は **アプリ起動中3秒間隔で繰り返し**。通知は1分間隔で送信。

## 6. バックグラウンド対応

- バックグラウンド移行時に `backgroundDate` を記録。FG 用アラートタイマーは停止。
- **Free 超過中に BG 遷移**: 10秒間隔×30個の通知を事前予約（`TIMER_ALERT_BG_1` 〜 `TIMER_ALERT_BG_30`）。
- **Free カウントダウン中に BG 遷移**: 目標到達時の通知＋到達後の10秒間隔通知もまとめて予約。
- フォアグラウンド復帰時に差分を `elapsed` に加算してキャッチアップ。
- **一時停止中はキャッチアップしない。**
- Free 超過状態で復帰した場合、FG アラートを再開する。
- 復帰時に未発火の BG 通知をすべてキャンセル。

## 7. デザイン定数

| 定数 | 値 | 用途 |
|------|-----|------|
| Work 背景（上） | `rgb(0.18, 0.10, 0.07)` | Work グラデーション上部 |
| Work 背景（下） | `rgb(0.12, 0.06, 0.04)` | Work グラデーション下部 |
| Work アクセント | `rgb(0.87, 0.62, 0.40)` | 銅・コッパー |
| Free 背景（上） | `rgb(0.05, 0.10, 0.18)` | Free グラデーション上部 |
| Free 背景（下） | `rgb(0.03, 0.06, 0.12)` | Free グラデーション下部 |
| Free アクセント | `rgb(0.45, 0.70, 0.78)` | ティール |
| 超過 Good | `rgb(0.55, 0.75, 0.51)` | Work 超過時タイマー文字色（セージグリーン） |
| 超過 Bad | `rgb(0.83, 0.48, 0.48)` | Free 超過時タイマー文字色（コーラル） |
| ベース背景 | `rgb(0.07, 0.06, 0.08)` | 開始・完了画面の背景 |

## 8. 非機能要件

- **プラットフォーム**: iOS 17.0+ (SwiftUI)
- **フレームワーク**: SwiftUI, Charts, UserNotifications, AudioToolbox
- **永続化**: UserDefaults + JSON エンコーディング
- **画面遷移**: アニメーションなし（即時切替）
